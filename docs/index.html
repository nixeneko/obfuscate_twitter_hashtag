<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8"> 
 <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
 <title>Twitterハッシュタグ難読化</title>
 <style type="text/css">
button{
  height: 3rem;
  width: 3rem;
  font-family : inherit;
  font-size: 100%;
}
#buttons_pc{
  margin-left:0.7rem;
}
#buttons_phone{
  text-align: center;
}
@media screen and (max-width:680px){
  .container{
    width: 100%;
  }
  .textarea_container{
    width: 100%;
  }
  textarea {
   width: 100%;
   resize: vertical;
   font-family : inherit;
   font-size: 100%;
   height: 8em;
  }
}
@media screen and (min-width:680px){
  .container{
    display: grid;
    align-items: center;
    grid-template-columns: 1fr 4rem 1fr;
    grid-template-rows: 2rem 16em;
  }
  textarea {
    width: 100%;
    font-family : inherit;
    font-size: 100%;
    height: 16em;
  }
  #legend_orig{
    display: block;
    grid-row: 1 / 2;
    grid-column: 1 / 2;
  }
  #texcont_orig{
    grid-row: 2 / 3;
    grid-column: 1 / 2;
  }
  #legend_conv{
    white-space: nowrap; 
    grid-row: 1 / 2;
    grid-column: 3 / 4;
  }
  #texcont_conv{
    grid-row: 2 / 3;
    grid-column: 3 / 4;
  }
  #buttons_pc{
    grid-row: 2 / 3;
    grid-column: 2 / 3;
  }
}
 </style>
 <script type="text/javascript" src="./conversion_data.js"></script>
 <script type="text/javascript">
//conversion_data = {"mapping_ligatures":...,"mapping_single_chars":..., "combining_marks":...}
function convert(){
  mapping_ligatures = conversion_data["mapping_ligatures"];
  mapping_single_chars = conversion_data["mapping_single_chars"];
  ignorable_marks = conversion_data["ignorable_marks"];
  tagable_chars = conversion_data["tagable_chars"];
  
  function replace_to_one_of_ligatures(key){
    key = key.toLowerCase();
    candidate_array = mapping_ligatures[key];
    idx = Math.floor(Math.random() * candidate_array.length);
    return candidate_array[idx];
  }
  function replace_to_one_of_chars(key){
    key = key.toLowerCase();
    candidate_array = mapping_single_chars[key];
    idx = Math.floor(Math.random() * candidate_array.length);
    return candidate_array[idx];
  }
  /*
  function add_diacritics(s, min, max){
    console.log(s);

    times = Math.floor(Math.random() * (max - min)) + min;
    ss = s;
    for (i = 0; i < times; i++){
      ss += get_random_mark();
    }
	console.log(ss);
    //return ss;
    return "0";
  }
  function get_func_add_diacritics(min, max){
    return function(s){add_diacritics(s, min, max);};
  }*/
  function get_random_mark(){
    idx = Math.floor(Math.random() * ignorable_marks.length);
    return ignorable_marks[idx];
  }
  function add_marks(s_in, min, max){
    chars = [...s_in];
    s = "";
    for (i = 0; i < chars.length; i++){
      c = chars[i];
      s += c;
	  //タグに使える文字でなければスキップ
      if (!tagable_chars.includes(c)) continue;
	  
	  times = Math.floor(Math.random() * (max - min + 1)) + min ;
	  //console.log(times);
      for (j = 0; j < times; j++){
        s += get_random_mark();
      }
    }
    /*return s;*/
	return s;
  }
  
  text = document.forms.mainForm.orig.value;
  text = text.normalize("NFKD"); //normalize
  //remove diacritics
  for (i = 0; i < ignorable_marks.length; i++) { // for (... in ...)にすると正規化されるっぽくてうまくいかない
    c = ignorable_marks[i];
    text = text.replace(c, "");
  }
  text = text.normalize("NFKC"); //normalize: composite
  for (key in mapping_ligatures){ //replace ligatures
    regex = new RegExp(key, 'ig'); //case-insensitive
    text = text.replaceAll(regex, replace_to_one_of_ligatures);
  }
  for (key in mapping_single_chars){ //replace single chars
    regex = new RegExp(key, 'ig'); //case-insensitive
    text = text.replaceAll(regex, replace_to_one_of_chars);
  }
  // add diacritics if it's a letter
  min_marks = 0;
  max_marks = 3;
  text = add_marks(text, min_marks, max_marks);
    
  document.forms.mainForm.conv.value=text;
}

function winsize_changed(){
  if (window.matchMedia("(max-width:680px)").matches){
    document.getElementById("buttons_pc").style.display = "none";
    document.getElementById("buttons_phone").style.display = "block";
  }else{
    document.getElementById("buttons_pc").style.display = "block";
    document.getElementById("buttons_phone").style.display = "none";
  }
}
document.addEventListener('DOMContentLoaded', winsize_changed);
window.addEventListener('resize', winsize_changed, false);

 </script>
</head>
<body>
<h1>Twitterハッシュタグ難読化</h1>
<p>Twitterのハッシュタグを、等価に解釈される難読化されたハッシュタグに変換することを目指しています。<br>数字やラテン文字に特に効果がありますが、それ以外だとうまくいかないかもしれません。</p>
<p>もし、ハッシュタグとして等価にならない場合があれば<a href="https://twitter.com/nixeneko">@nixeneko</a>まで教えていただければ幸いです。</p>
<form name="mainForm">
 <div class="container">
  <legend id="legend_orig">変換前(ハッシュタグ以外は入力しないでください)</legend>
  <div class="textarea_container" id="texcont_orig">
   <textarea name="orig"></textarea>
  </div>
  <div id="buttons_pc">
   <div><button type="button" onclick="convert();">→</button></div>
  </div>
  <div id="buttons_phone" style="display:none;">
   <div><button type="button" onclick="convert();">↓</button></div>
  </div>
  <legend id="legend_conv">変換後</legend>
  <div class="textarea_container" id="texcont_conv">
   <textarea name="conv"></textarea>
  </div>
 </div>
</form>
</body>
</html>